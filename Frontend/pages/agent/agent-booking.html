<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harbor Management Agent Dashboard</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    :root {
        --primary-blue: #2563eb;
        --secondary-blue: #1e40af;
        --light-blue: #3b82f6;
        --bg-gray: #f8f9fa;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --card-bg: #ffffff;
        --border-color: #e5e7eb;
    }
    [data-bs-theme="dark"] {
        --primary-blue: #3b82f6;
        --secondary-blue: #2563eb;
        --light-blue: #60a5fa;
        --bg-gray: #111827;
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --card-bg: #1f2937;
        --border-color: #374151;
    }
    body { background-color: var(--bg-gray); color: var(--text-primary); transition: all 0.3s ease; }
    .navbar-custom { background-color: var(--primary-blue) !important; }
    .navbar-brand { font-weight: bold; color: white !important; }
    .nav-link { color: #bfdbfe !important; transition: all 0.3s ease; }
    .nav-link:hover, .nav-link.active { color: white !important; background-color: var(--secondary-blue); border-radius: 6px; }
    .profile-avatar { width: 32px; height: 32px; background-color: var(--light-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }
    .card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
    .card-header { background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); }
    .theme-toggle { background: none; border: 1px solid rgba(255,255,255,0.3); color: #bfdbfe; padding: 6px 12px; border-radius: 6px; transition: all 0.3s ease; }
    .theme-toggle:hover { background-color: rgba(255,255,255,0.1); color: white; }

    /* Stripe Modal Enhancements */
#stripePaymentModal .modal-content {
    background: #ffffff;
    transition: all 0.3s ease;
}

#stripePaymentModal .modal-body {
    padding-top: 1rem;
}

#stripePaymentModal #card-element {
    min-height: 45px;
    background-color: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ced4da;
}

#stripePaymentModal #card-element.StripeElement--focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
}

#stripePaymentModal button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
</head>
<body data-bs-theme="light">

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-custom">
<div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="fas fa-anchor me-2"></i>
        MarineX Agent-Dashboard
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link active px-3" href="agent-dashboard.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link px-3" href="agent-booking.html"><i class="fas fa-calendar me-1"></i> Bookings</a></li>
            <li class="nav-item"><a class="nav-link px-3" href="vessel-management.html"><i class="fas fa-ship me-1"></i> Vessels</a></li>
            <li class="nav-item"><a class="nav-link px-3" href="agent-payment.html"><i class="fas fa-credit-card me-1"></i> Payment History</a></li>
            <li class="nav-item"><a class="nav-link px-3" href="agent-others.html"><i class="fas fa-ellipsis-h me-1"></i> Others</a></li>
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item"><button class="theme-toggle me-3" onclick="toggleTheme()"><i class="fas fa-moon" id="theme-icon"></i></button></li>
            <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-bell"></i></a></li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                    <div class="profile-avatar me-2"><i class="fas fa-user"></i></div>
                    <span class="d-none d-md-block">Agent</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile Update</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>
</nav>

<!-- Main Content -->
<main class="container mt-4">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-calendar me-2"></i>Manage Bookings</h3>
    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#bookingFormSection"><i class="fas fa-plus"></i> New Booking</button>
</div>

<!-- Booking Form -->
<div class="collapse mb-4" id="bookingFormSection">
    <div class="card">
        <div class="card-header"><h5 class="mb-0">Add / Update Booking</h5></div>
        <div class="card-body">
            <form id="bookingForm">
                <input type="hidden" id="bookingId">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Vessel</label>
                        <select id="vesselId" class="form-select" required>
                            <option value="">Select Vessel</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Berth</label>
                        <select id="berthId" class="form-select" required>
                            <option value="">Select Berth</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Services</label>
                        <select id="serviceIds" class="form-select" multiple required></select>
                        <small class="text-muted">Hold Ctrl (Windows) / Cmd (Mac) to select multiple</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Purpose</label>
                        <select id="purpose" class="form-select" required>
                            <option value="">Select Purpose</option>
                            <option value="CARGO_LOAD">Cargo Load</option>
                            <option value="CARGO_UNLOAD">Cargo Unload</option>
                            <option value="PASSENGER_BOARDING">Passenger Boarding</option>
                            <option value="PASSENGER_ALIGHTING">Passenger Alighting</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Start Date & Time</label>
                        <input type="datetime-local" id="bookingDate" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">End Date & Time</label>
                        <input type="datetime-local" id="endDate" class="form-control" required>
                    </div>
                </div>
                <div class="mt-3 text-end">
                    <button type="reset" class="btn btn-secondary">Clear</button>
                    <button type="submit" class="btn btn-success">Save Booking</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bookings Table -->
<div class="card">
    <div class="card-header"><h5 class="mb-0">My Bookings</h5></div>
    <div class="card-body table-responsive">
        <table class="table table-striped table-hover align-middle" id="bookingsTable">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Vessel</th>
                    <th>Berth</th>
                    <th>Services</th>
                    <th>Purpose</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Total Price</th>
                    <th>Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Stripe Payment Modal -->
<div class="modal fade" id="stripePaymentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold"><i class="fas fa-credit-card me-2"></i>Pay Booking</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2">
        <p class="text-muted small mb-3">Enter your card details to complete the payment securely.</p>
        <form id="stripePaymentForm">
          <div class="mb-3">
            <label for="card-element" class="form-label fw-semibold">Card Details</label>
            <div id="card-element" class="form-control p-3 rounded-3 border border-secondary"></div>
          </div>
          <div id="card-errors" class="text-danger mb-3 small"></div>
          <input type="hidden" id="paymentBookingId">
          <button type="submit" class="btn btn-primary w-100 py-2 fw-semibold shadow-sm">
            <i class="fas fa-lock me-2"></i>Pay Now
          </button>
        </form>
        <hr class="my-3">
        <p class="text-center text-muted small mb-0">
          Powered by <span class="fw-bold">Stripe</span>
        </p>
      </div>
    </div>
  </div>
</div>

</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);

    const token = localStorage.getItem("token");
    const agentId = Number(localStorage.getItem("agentId"));
    if (!token || !agentId) { alert("You must log in first!"); window.location.href = "login.html"; return; }

    const vesselMap = new Map(), berthMap = new Map(), serviceMap = new Map();
    loadVessels(agentId, token, vesselMap);
    loadBerths(token, berthMap);
    loadServices(token, serviceMap);
    loadBookings(agentId, token, vesselMap, berthMap, serviceMap);

    document.getElementById("bookingForm").addEventListener("submit", async e => {
        e.preventDefault();
        const bookingId = document.getElementById("bookingId").value;
        const vesselId = Number(document.getElementById("vesselId").value);
        const berthId = Number(document.getElementById("berthId").value);
        const serviceIds = Array.from(document.getElementById("serviceIds").selectedOptions).map(opt => Number(opt.value));
        const purpose = document.getElementById("purpose").value;
        if (!vesselId || !berthId || !purpose) { alert("Please select Vessel, Berth, and Purpose!"); return; }

        const bookingData = {
            vesselId, berthId, agentId, serviceIds, purpose,
            bookingDate: document.getElementById("bookingDate").value,
            endDate: document.getElementById("endDate").value
        };

        const url = bookingId ? `http://localhost:8080/api/bookings/${bookingId}` : `http://localhost:8080/api/bookings`;
        const method = bookingId ? "PUT" : "POST";

        try {
            const res = await fetch(url, { 
                method, 
                headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }, 
                body: JSON.stringify(bookingData) 
            });
            if (!res.ok) throw new Error(`Server error ${res.status}`);
            alert("✅ Booking saved successfully");
            document.getElementById("bookingForm").reset();
            loadBookings(agentId, token, vesselMap, berthMap, serviceMap);
        } catch (err) { console.error("❌ Error saving booking:", err); alert("Failed to save booking."); }
    });
});

function toggleTheme() {
    const newTheme = document.body.getAttribute('data-bs-theme') === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
}

function setTheme(theme) {
    document.body.setAttribute('data-bs-theme', theme);
    document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    localStorage.setItem('theme', theme);
}

const currentPage = window.location.pathname.split("/").pop();
document.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.getAttribute('href') === currentPage));

function loadVessels(agentId, token, vesselMap) {
    fetch(`http://localhost:8080/api/vessels/agent/${agentId}`, { headers: { "Authorization": "Bearer " + token } })
    .then(res => res.json())
    .then(vessels => {
        const sel = document.getElementById("vesselId");
        sel.innerHTML = `<option value="">Select Vessel</option>`;
        vesselMap.clear();
        vessels.forEach(v => { vesselMap.set(v.vesselId, v.name); sel.innerHTML += `<option value="${v.vesselId}">${v.name}</option>`; });
    }).catch(err => console.error(err));
}

function loadBerths(token, berthMap) {
    fetch("http://localhost:8080/api/berths", { headers: { "Authorization": "Bearer " + token } })
    .then(res => res.json())
    .then(berths => {
        const sel = document.getElementById("berthId");
        sel.innerHTML = `<option value="">Select Berth</option>`;
        berthMap.clear();
        berths.forEach(b => { berthMap.set(b.berthId, { number: b.berthNumber, price: Number(b.price) }); sel.innerHTML += `<option value="${b.berthId}">Berth ${b.berthNumber} - ${b.status} (Cap: ${b.capacity}, $${b.price})</option>`; });
    }).catch(err => console.error(err));
}

function loadServices(token, serviceMap) {
    fetch("http://localhost:8080/api/services", { headers: { "Authorization": "Bearer " + token } })
    .then(res => res.json())
    .then(services => {
        if (services.data) services = services.data;
        const sel = document.getElementById("serviceIds");
        sel.innerHTML = "";
        serviceMap.clear();
        services.forEach(s => { serviceMap.set(s.serviceId, s); sel.innerHTML += `<option value="${s.serviceId}">${s.name} - $${s.price}</option>`; });
    }).catch(err => console.error(err));
}


function loadBookings(agentId, token, vesselMap, berthMap, serviceMap) {
    fetch(`http://localhost:8080/api/bookings/agent/${agentId}`, { headers: { "Authorization": "Bearer " + token } })
    .then(res => res.json())
    .then(bookings => {
        const tbody = document.querySelector("#bookingsTable tbody");
        tbody.innerHTML = "";

        bookings.forEach((b, i) => {
            const vesselName = vesselMap.get(b.vesselId) || b.vesselId;
            const berthData = berthMap.get(b.berthId) || {};
            const serviceNames = (b.serviceIds || []).map(id => serviceMap.get(id)?.name || id).join(", ");

            let actionButtons = '';
            if (b.status === "APPROVED") {
                actionButtons = `<button class="btn btn-sm btn-success" onclick="payBooking(${b.bookingId})">Pay Now</button>`;
            } else if (b.status === "CONFIRMED") {
                actionButtons = `
                    <button class="btn btn-sm btn-warning" disabled>Edit</button>
                    <button class="btn btn-sm btn-danger" disabled>Delete</button>
                `;
            } else if (b.status === "COMPLETED") {
                actionButtons = `<span class="badge bg-danger fw-bold">Paid</span>`;
            } else {
                actionButtons = `
                    <button class="btn btn-sm btn-warning" onclick="editBooking(${b.bookingId})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBooking(${b.bookingId})">Delete</button>
                `;
            }

            // Optional: add color for status
            let statusLabel = '';
            switch(b.status) {
                case "PENDING": statusLabel = `<span class="badge bg-secondary">PENDING</span>`; break;
                case "APPROVED": statusLabel = `<span class="badge bg-primary">APPROVED</span>`; break;
                case "CONFIRMED": statusLabel = `<span class="badge bg-success">CONFIRMED</span>`; break;
                case "COMPLETED": statusLabel = `<span class="badge bg-danger">COMPLETED</span>`; break;
                default: statusLabel = b.status;
            }

            tbody.innerHTML += `<tr>
                <td>${i+1}</td>
                <td>${vesselName}</td>
                <td>${berthData.number || b.berthId}</td>
                <td>${serviceNames}</td>
                <td>${b.purpose || ''}</td>
                <td>${b.bookingDate || ""}</td>
                <td>${b.endDate || ""}</td>
                <td>${b.totalPrice || 0}</td>
                <td>${statusLabel}</td>
                <td class="text-center">${actionButtons}</td>
            </tr>`;
        });
    }).catch(err => console.error(err));
}

function payBooking(bookingId) {
      const row = document.querySelector(`#bookingsTable tbody tr td button[onclick="payBooking(${bookingId})"]`).closest('tr');
    const totalPrice = Number(row.cells[7].innerText); // totalPrice is in the 8th column
    const paymentAmount = (totalPrice * 0.2).toFixed(2);

    if (confirm(`Pay 20% of total price: $${paymentAmount}?`)) {
        // Call backend to mark payment (we'll implement this later)
        alert(`Payment of $${paymentAmount} for booking ID ${bookingId} is recorded.`);
    }
}

//stripe payment integration (to be implemented)

// Replace this with your Stripe publishable key
const stripe = Stripe("pk_test_51S8gBiRtg8p4PLbs2XzTqEoEplHgHaLpigo2B5g6zZcW6G9BkIWyObTH0VMYJR1mkkjklAAiQfP4fzohdwh4UhHB00wooHGPor"); 
// Create Stripe elements
const elements = stripe.elements();
const card = elements.create("card", { hidePostalCode: true });
card.mount("#card-element");

// Show error messages
card.addEventListener("change", function(event) {
    const displayError = document.getElementById("card-errors");
    displayError.textContent = event.error ? event.error.message : "";
});


function payBooking(bookingId) {
    const row = document.querySelector(`#bookingsTable tbody tr td button[onclick="payBooking(${bookingId})"]`).closest('tr');
    const totalPrice = Number(row.cells[7].innerText);
    const paymentAmount = (totalPrice * 0.2).toFixed(2);

    document.getElementById("paymentBookingId").value = bookingId;

    // Show modal
    const stripeModal = new bootstrap.Modal(document.getElementById("stripePaymentModal"));
    stripeModal.show();
}
document.getElementById("stripePaymentForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const bookingId = Number(document.getElementById("paymentBookingId").value);
    const row = document.querySelector(`#bookingsTable tbody tr td button[onclick="payBooking(${bookingId})"]`).closest('tr');
    const totalPrice = Number(row.cells[7].innerText);
    const paymentAmount = (totalPrice * 0.2).toFixed(2);

    try {
        const token = localStorage.getItem("token");

        // Call backend to save payment
        const res = await fetch("http://localhost:8080/api/payments", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify({
                bookingId,
                amount: Number(paymentAmount),
                method: "CARD"
            })
        });

        if (!res.ok) throw new Error("Payment failed");

        alert(`✅ Payment of $${paymentAmount} successful! Invoice sent via email.`);

        // Close modal
        const stripeModalEl = document.getElementById("stripePaymentModal");
        const stripeModal = bootstrap.Modal.getInstance(stripeModalEl);
        stripeModal.hide();

        // Reload bookings table to reflect CONFIRMED
        const agentId = Number(localStorage.getItem("agentId"));
        const vesselMap = new Map(), berthMap = new Map(), serviceMap = new Map();
        loadBookings(agentId, token, vesselMap, berthMap, serviceMap);

    } catch (err) {
        console.error(err);
        document.getElementById("card-errors").textContent = "Payment failed. Try again.";
    }
});

</script>

</body>
</html>
